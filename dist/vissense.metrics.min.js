/*! { "name": "vissense-metrics", "version": "0.1.0", "copyright": "(c) 2015 tbk" } */
!function(a){"use strict";!function(a){Date.now||(Date.now=function(){return(new Date).getTime()}),a.performance||(a.performance=a.performance||{},a.performance.now=a.performance.now||a.performance.mozNow||a.performance.msNow||a.performance.oNow||a.performance.webkitNow||Date.now)}(a);var b=function(){function a(b){return this instanceof a?((+b!==b||0>b)&&(b=0),void(this._$={i:b})):new a(b)}var b=Math.pow(2,32),c=function(a){return+a!==a?1:+a};return a.MAX_VALUE=b,a.prototype.inc=function(a){return this.set(this.get()+c(a)),this.get()},a.prototype.dec=function(a){return this.inc(-1*c(a))},a.prototype.clear=function(){var a=this._$.i;return this._$.i=0,a},a.prototype.get=function(){return this._$.i},a.prototype.set=function(a){return this._$.i=c(a),this._$.i<0?this._$.i=0:this._$.i>b&&(this._$.i-=b),this.get()},a}(),c=function(){function b(a){return this instanceof b?(this._config=a||{},this._config.performance=this._config.performance===!0,void(this._$={ts:0,te:0,r:!1})):new b(a)}var c=function(b){return b?a.performance.now():Date.now()},d=function(a,b){return+a===a?+a:b};return b.prototype._orNow=function(a){return d(a,c(this._config.performance))},b.prototype.startIf=function(a,b){return a&&(this._$.r=!0,this._$.ts=this._orNow(b),this._$.te=null),this},b.prototype.start=function(a){return this.startIf(!this._$.r,a)},b.prototype.restart=function(a){return this.startIf(!0,a)},b.prototype.stop=function(a){return this.stopIf(!0,a)},b.prototype.stopIf=function(a,b){return this._$.r&&a&&(this._$.te=this._orNow(b),this._$.r=!1),this},b.prototype.interim=function(a){return this._$.r?this._orNow(a)-this._$.ts:0},b.prototype.get=function(a){return this._$.te?this._$.te-this._$.ts:this.time(a)},b.prototype.running=function(){return this._$.r},b.prototype.getAndRestartIf=function(a,b){var c=this.get(b);return a&&this.restart(b),c},b.prototype.forceStart=b.prototype.restart,b.prototype.time=b.prototype.interim,b}();a.CountOnMe={counter:b,stopwatch:c}}(window),function(a,b,c,d){"use strict";function e(a,b){a>0&&b(a)}function f(){this.metrics={},this.addMetric=function(a,b){this.metrics[a]=b},this.getMetric=function(a){return this.metrics[a]}}function g(a){function b(a){var b=a.state(),c=b.percentage;h.getMetric("percentage").set(c),c<h.getMetric("percentage.min").get()&&h.getMetric("percentage.min").set(c),c>h.getMetric("percentage.max").get()&&h.getMetric("percentage.max").set(c)}function c(a){var b=a.state();e(l.get(),function(a){h.getMetric("time.duration").set(a)}),e(k.running()?k.stop().get():-1,function(a){h.getMetric("time.hidden").inc(a)}),e(i.running()?i.stop().get():-1,function(a){h.getMetric("time.visible").inc(a),h.getMetric("time.relativeVisible").inc(a*b.percentage)}),e(j.running()?j.stop().get():-1,function(a){h.getMetric("time.fullyvisible").inc(a)}),i.startIf(b.visible),j.startIf(b.fullyvisible),k.startIf(b.hidden),l.startIf(!l.running())}var g=!1,h=new f,i=d.stopwatch(),j=d.stopwatch(),k=d.stopwatch(),l=d.stopwatch();h.addMetric("time.visible",new d.counter),h.addMetric("time.fullyvisible",new d.counter),h.addMetric("time.hidden",new d.counter),h.addMetric("time.relativeVisible",new d.counter),h.addMetric("time.duration",new d.counter),h.addMetric("percentage",new d.counter),h.addMetric("percentage.max",new d.counter(0)),h.addMetric("percentage.min",new d.counter(1));var m=this;this.update=function(){c(a),b(a)},this.getMetric=function(a){return h.getMetric(a)},this.running=function(){return g};var n=null;this.start=function(){return g||(n=a.on("update",function(){m.update()}),this.update(),g=!0),this},this.stop=function(){return g&&(this.update(),n(),n=null,g=!1),this}}var h=b.VisMon.Strategy;h.MetricsStrategy=function(){},h.MetricsStrategy.prototype=Object.create(h.prototype),h.MetricsStrategy.prototype.init=function(a){var b=new g(a);a.metrics=function(){return b}},h.MetricsStrategy.prototype.start=function(a){return a.metrics().start(),!0},h.MetricsStrategy.prototype.stop=function(a){return a.metrics().stop(),!0}}.call(this,window,window.VisSense,window.VisSense.Utils,window.CountOnMe);