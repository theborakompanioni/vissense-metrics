/*! { "name": "vissense-metrics", "version": "0.0.1-rc1", "copyright": "(c) 2015 tbk" } */
!function(a){"use strict";!function(a){Date.now||(Date.now=function(){return(new Date).getTime()}),a.performance||(a.performance=a.performance||{},a.performance.now=a.performance.now||a.performance.mozNow||a.performance.msNow||a.performance.oNow||a.performance.webkitNow||Date.now)}(a);var b=function(){function a(b){return this instanceof a?((+b!==b||0>b)&&(b=0),void(this._$={i:b})):new a(b)}var b=Math.pow(2,32),c=function(a){return+a!==a?1:+a};return a.MAX_VALUE=b,a.prototype.inc=function(a){return this.set(this.get()+c(a)),this.get()},a.prototype.dec=function(a){return this.inc(-1*c(a))},a.prototype.clear=function(){var a=this._$.i;return this._$.i=0,a},a.prototype.get=function(){return this._$.i},a.prototype.set=function(a){return this._$.i=c(a),this._$.i<0?this._$.i=0:this._$.i>b&&(this._$.i-=b),this.get()},a}(),c=function(){function b(a){return this instanceof b?(this._config=a||{},this._config.performance=this._config.performance===!0,void(this._$={ts:0,te:0,r:!1})):new b(a)}var c=function(b){return b?a.performance.now():Date.now()},d=function(a,b){return+a===a?+a:b};return b.prototype._orNow=function(a){return d(a,c(this._config.performance))},b.prototype.startIf=function(a,b){return a&&(this._$.r=!0,this._$.ts=this._orNow(b),this._$.te=null),this},b.prototype.start=function(a){return this.startIf(!this._$.r,a)},b.prototype.restart=function(a){return this.startIf(!0,a)},b.prototype.stop=function(a){return this.stopIf(!0,a)},b.prototype.stopIf=function(a,b){return this._$.r&&a&&(this._$.te=this._orNow(b),this._$.r=!1),this},b.prototype.interim=function(a){return this._$.r?this._orNow(a)-this._$.ts:0},b.prototype.get=function(a){return this._$.te?this._$.te-this._$.ts:this.time(a)},b.prototype.running=function(){return this._$.r},b.prototype.getAndRestartIf=function(a,b){var c=this.get(b);return a&&this.restart(b),c},b.prototype.forceStart=b.prototype.restart,b.prototype.time=b.prototype.interim,b}();a.CountOnMe={counter:b,stopwatch:c}}(window),function(a,b,c,d){"use strict";function e(a,b){a>0&&b(a)}function f(){this.metrics={},this.addMetric=function(a,b){this.metrics[a]=b},this.getMetric=function(a){return this.metrics[a]}}function g(a){function b(a){var b=a.state(),c=b.percentage;i.getMetric("percentage").set(c),c<i.getMetric("percentage.min").get()&&i.getMetric("percentage.min").set(c),c>i.getMetric("percentage.max").get()&&i.getMetric("percentage.max").set(c)}function c(a){var b=a.state();e(m.get(),function(a){i.getMetric("time.duration").set(a)}),e(l.running()?l.stop().get():-1,function(a){i.getMetric("time.hidden").inc(a)}),e(j.running()?j.stop().get():-1,function(a){i.getMetric("time.visible").inc(a),i.getMetric("time.relativeVisible").inc(a*b.percentage)}),e(k.running()?k.stop().get():-1,function(a){i.getMetric("time.fullyvisible").inc(a)}),j.startIf(b.visible),k.startIf(b.fullyvisible),l.startIf(b.hidden),m.startIf(!m.running())}var g=this,h=!1,i=new f,j=d.stopwatch(),k=d.stopwatch(),l=d.stopwatch(),m=d.stopwatch();i.addMetric("time.visible",new d.counter),i.addMetric("time.fullyvisible",new d.counter),i.addMetric("time.hidden",new d.counter),i.addMetric("time.relativeVisible",new d.counter),i.addMetric("time.duration",new d.counter),i.addMetric("percentage",new d.counter),i.addMetric("percentage.max",new d.counter(0)),i.addMetric("percentage.min",new d.counter(1));var n=function(){c(a),b(a)};a.onUpdate(function(){n()}),g.getMetric=function(a){return i.getMetric(a)},g.running=function(){return h},g.start=function(){return h||(a.start(),n(),h=!0),this},g.stop=function(){return h&&(n(),a.stop(),h=!1),this}}b.fn.metrics=function(a){if(this._metrics)return this._metrics;var b=a||{};return this._metrics=new g(this.monitor(b)),this._metrics}}.call(this,window,window.VisSense,window.VisSense.Utils,window.CountOnMe);